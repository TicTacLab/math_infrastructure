- name: Update Malt Engine
  hosts: malt_engine
  tasks:
    - name: Stop Service
      service: name=malt_engine state=stopped
      sudo: yes

    - name: Clone project
      git: repo=gitolite@git.favorit:malt_engine
           dest=malt_engine
           update=yes
           version="{{git_ref}}"
           accept_hostkey=True
      register: project

    - stat: path=malt_engine/target/malt-standalone.jar
      register: jar

    - name: Build proto files
      command: lein protobuf
      args:
        chdir: malt_engine
      when: project.changed or not jar.stat.exists

    - name: Cleanup target
      file: path=malt_engine/target state=absent
      when: project.changed or not jar.stat.exists

    - name: Make jar file
      command: lein uberjar
      args:
        chdir: malt_engine
      when: project.changed or not jar.stat.exists

    - name: Start Service
      service: name=malt_engine state=started
      sudo: yes
